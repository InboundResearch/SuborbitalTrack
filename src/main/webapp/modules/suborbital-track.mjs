import"https://astro.irdev.us/modules/satellite.mjs";import{WebGL2,LogLevel,Utility,Float2,Float3,Float4x4}from"https://webgl.irdev.us/webgl.mjs";export let SuborbitalTrack=function(e,D,t,N=function(e){}){let a=Object.create(null);let p=a.wgl=WebGL2();let H=p.ClassBase;let l=p.RollingStats;let k=p.PointerTracker;let o=p.OnReady;let B=p.Render;let Y=p.LoaderShader;let n=p.LoaderPath;let r=p.Texture;let s=p.TextFile;let X=p.Loader;let d=p.Program;let c=p.makeBall;let q=p.Shape;let f=p.Node;let F=p.Thing;let i;let x;let z;const T=1e3;const u=T/60;let R=0;let S=l.new({count:60,fill:u});let E=l.new({count:60,fill:u});let G=l.new({count:60,fill:0});let M=Object.create(null);const g=[0,0,0,1];let P=function(l){let e=f.get(l);if(e){return Float4x4.preMultiply(g,e.getTransform())}else if(tle&&l in tle.elementIndex){let a=f.get("tle");if(a){let e=a.instanceTransforms.matrices[tle.elementIndex[l]];let t=Float4x4.multiply(a.getTransform(),e);return Float4x4.preMultiply(g,t)}}return g};let m=document.visibilityState;document.addEventListener("visibilitychange",function(e){m=document.visibilityState;A()});let h="focus";window.addEventListener("focus",function(e){h="focus";A()});window.addEventListener("blur",function(e){h="blur";A()});let w=true;let A=function(){if(m==="visible"&&h==="focus"){w=true;i.focus();window.requestAnimationFrame(O)}else{w=false;S.reset();E.reset();J=0}};const j=[1,0,0,1];let y=function(e){let t=f.get(e).getTransform();let a=Float4x4.preMultiply(g,t);let l=Float4x4.preMultiply(j,t);let o=Float3.subtract(l,a);return Float3.norm(o)};let I={hz:0,ms:0};let V=function(o){const n=30;let t=0;let r=0;let s=0;let a=0;let i=function(l){let e=performance.now();if(l===a){LogLevel.warn("Repeated frame time");window.requestAnimationFrame(i);return}a=l;if(r===0){r=l;window.requestAnimationFrame(i);return}s+=e-l;if(++t<n){window.requestAnimationFrame(i)}else{let e=s/n;if(e>1){LogLevel.error("performance counter is not aligned with frame timestamp (avg delta: "+e.toFixed(2)+" ms)")}let t=T/((l-r)/n);let a=Math.round(t);if(a%5!==0&&a%12!==0){a=60;LogLevel.warn("Monitor Refresh Rate is strange")}LogLevel.info("Monitor Refresh Rate = "+a+" Hz ("+t.toFixed(3)+" Hz)");I={hz:a,ms:T/a};o()}};window.requestAnimationFrame(i)};let L=performance.now();let W=Date.now()-L;let C=10;let b;let J=0;let _=0;let O=function(h){if(w===true){let l=performance.now();let o=l-h;o=G.update(o).avg;window.requestAnimationFrame(O);let n=h-_;_=h;let e=L+W+C*(l-L);let t=new Date(e);b=computeJ2000(t);updateSolarSystem(b);F.updateAll(b);if(tle){tle.updateElements(t,f.get("tle").instanceTransforms.matrices)}let w=cameraSettings[v.name].currentPosition;let A;switch(v.type){case"fixed":{let e=P(v.from);let t=P(v.at);A=Float4x4.lookFromAt(e,t,[0,1,0]);break}case"skewer":{let e=P(v.from);let t=P(v.at);let a=Float3.subtract(e,t);let l=Float3.norm(a);e=Float3.add(t,Float3.scale(a,(l+v.distance)/l));A=Float4x4.lookFromAt(e,t,[0,1,0]);break}case"portrait":case"orbit":{let e=P(v.at);let t=y(v.at);let a=t/(v.zoom*.9+.1);let l=Utility.sin(v.fov/2);let o=a/l;let n=Float4x4.preMultiply([0,0,0,1],Float4x4.chain(Float4x4.translate([o,0,0]),Float4x4.rotateZ(w[1]*Math.PI*.5),Float4x4.rotateY(w[0]*Math.PI*-1),Float4x4.translate(e)));A=Float4x4.lookFromAt(n,e,[0,1,0]);break}case"gimbal":{let e=P(v.from);let t=P(v.at);let a=P(v.up);let l=Float3.normalize(Float3.subtract(a,e));A=Float4x4.lookFromAt(e,t,l);break}case"target":{let e=v.targets;let a=[0,0,0];let l=[];for(let t of e){let e=P(t);l.push(e);a=Float3.add(a,e)}a=Float3.scale(a,1/e.length);let o=0;for(let t of l){let e=Float3.subtract(a,t);e[1]=0;o=Math.max(Float3.norm(e),o)}let t=o/(v.zoom*1.8+.2);let n=Utility.tan(v.fov/2);let r=t/n;let s=Float4x4.preMultiply(g,Float4x4.chain(Float4x4.translate([r,0,0]),Float4x4.rotateZ(w[1]*Math.PI*.5),Float4x4.rotateY(w[0]*Math.PI*-1),Float4x4.translate(a)));A=Float4x4.lookFromAt(s,a,[0,1,0]);break}case"ots":{let e=P(v.from);let t=y(v.from);let a=P(v.at);let l=y(v.at);let o=Float3.subtract(a,e);let n=Float3.norm(o);o=Float3.scale(o,1/n);let r=t/(v.zoom*.9+.1);let s=Utility.tan(v.fov/2);let i=r/s;let u=1-s*s;let d=t/n;let c=l/n;let m=d/c;let h=m/(1+m);let p=Math.asin(d/h)*2/u;let f=Math.max(.4*u,d);let F=Float3.add(Float3.scale(e,1-f),Float3.scale(a,f));i+=f*n+t+.1;let x=i*Math.sin(p/2)*1.5;let T=Float4x4.preMultiply(g,Float4x4.chain(Float4x4.translate(Float3.scale(o,-1*i)),Float4x4.translate(Float3.scale([0,1,0],w[1]*x)),Float4x4.rotateY(w[0]*p*-1),Float4x4.translate(F)));A=Float4x4.lookFromAt(T,F,[0,1,0]);break}}let r=p.getContext();r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);let a=60;let s=Float4x4.copy(A);s[12]=s[13]=s[14]=0;M.CAMERA_POSITION=[0,0,0];M.PROJECTION_MATRIX_PARAMETER=Float4x4.perspective(a,r.viewportWidth/r.viewportHeight,1e3,starSphereRadius*1.1);M.VIEW_MATRIX_PARAMETER=s;M.MODEL_MATRIX_PARAMETER=Float4x4.IDENTITY;starsScene.traverse(M);M.VIEW_MATRIX_PARAMETER=A;M.MODEL_MATRIX_PARAMETER=Float4x4.IDENTITY;let i=Float4x4.inverse(A);M.CAMERA_POSITION=[i[12],i[13],i[14]];let u=Float3.norm(M.CAMERA_POSITION);let d=solarSystem.moonR*1.1;let c=Math.max(.1,u-d);let m=u+d;M.PROJECTION_MATRIX_PARAMETER=Float4x4.perspective(v.fov,r.viewportWidth/r.viewportHeight,c,m);solarSystemScene.traverse(M);r.flush();if(n<T/4){let e=performance.now()-l;let t=E.update(e);let a=S.update(n);x.innerHTML=(T/a.avg).toFixed(1)+" / "+Utility.padNum((I.hz/(R+1)).toFixed(1),3)+" fps"+"<br>"+Utility.padNum(o.toFixed(1),5,"&nbsp")+" / "+Utility.padNum(t.avg.toFixed(1),5,"&nbsp")+" / "+Utility.padNum(a.avg.toFixed(1),5,"&nbsp")+" ms"+"<br>"+r.viewportWidth+" x "+r.viewportHeight}while(R>0&&performance.now()-l<I.ms*(R+.75)){}}};let Z=function(){c("ball",72);c("ball-med",36);c("ball-small",8);c("ball-tiny",5);Stars.make("Bright Stars",-2,6);Stars.make("Dim Stars",6,8);let t=p.getContext();t.clearColor(0,0,0,1);t.enable(t.CULL_FACE);t.cullFace(t.BACK);t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);t.enable(t.BLEND);M.AMBIENT_LIGHT_COLOR=[1,1,1];M.LIGHT_COLOR=[1,1,1];starsScene=f.new({state:function(e){t.disable(t.DEPTH_TEST);t.depthMask(false)}});let e=Float4x4.chain(Float4x4.rotateX(Math.PI),Float4x4.rotateY(Math.PI),Float4x4.scale(-starSphereRadius));let a=.66;starsScene.addChild(f.new({transform:Float4x4.scale(starSphereRadius),state:function(e){d.get("vertex-color").use();e.MODEL_COLOR=[1,1,1];e.OUTPUT_ALPHA_PARAMETER=a},shape:"Dim Stars"},"Dim Stars"));starsScene.addChild(f.new({transform:Float4x4.scale(starSphereRadius),state:function(e){d.get("vertex-color").use();e.MODEL_COLOR=[1,1,1];e.OUTPUT_ALPHA_PARAMETER=a},shape:"Bright Stars"},"Bright Stars"));starsScene.addChild(f.new({transform:e,state:function(e){d.get("texture").use();e.OUTPUT_ALPHA_PARAMETER=a*.5;e.TEXTURE_SAMPLER="starfield"},shape:"ball",children:false},"starfield"));let l=Blackbody.colorAtTemperature(5800);let o=f.new({transform:Float4x4.IDENTITY,state:function(e){d.get("color").use();e.OUTPUT_ALPHA_PARAMETER=1;e.MODEL_COLOR=l},shape:"ball-med",children:false},"sun");starsScene.addChild(o);F.new({node:"sun",update:function(e){let t=f.get(this.node);let a=sunDistance*solarSystem.sunR;let l=Float3.scale(solarSystem.sunDirection,a);let o=sunRadius/earthRadius*(sunDistance/a);t.transform=Float4x4.multiply(Float4x4.scale(o),Float4x4.translate(l));M.LIGHT_DIRECTION=solarSystem.sunDirection}},"sun");solarSystemScene=f.new({state:function(e){t.enable(t.DEPTH_TEST);t.depthMask(true)}});let n=f.new({transform:Float4x4.IDENTITY,state:function(e){d.get("shadowed-texture").use().setSunPosition(solarSystem.sunPosition);e.OUTPUT_ALPHA_PARAMETER=1;e.TEXTURE_SAMPLER="moon";e.MODEL_COLOR=[1,1,1];e.AMBIENT_CONTRIBUTION=.1;e.DIFFUSE_CONTRIBUTION=.95;e.SPECULAR_CONTRIBUTION=.05;e.SPECULAR_EXPONENT=8},shape:"ball-med",children:false},"moon");solarSystemScene.addChild(n);F.new({node:"moon",update:function(e){let t=f.get(this.node);t.transform=Float4x4.chain(Float4x4.scale(moonScale),Float4x4.rotateY(solarSystem.moonTheta),Float4x4.translate(Float3.scale(solarSystem.moonDirection,solarSystem.moonR)))}},"moon");let r=f.new({transform:Float4x4.IDENTITY},"world");solarSystemScene.addChild(r);r.addChild(f.new({transform:Float4x4.IDENTITY,children:false},"flyer"));F.new({node:"flyer",update:function(e){let t=f.get(this.node);t.transform=Float4x4.chain(Float4x4.scale(.01),Float4x4.translate([5e4/earthRadius,0,0]),Float4x4.rotateY(e*4e3*(1/C)),Float4x4.rotateZ(Utility.degreesToRadians(18)))}},"flyer");let s=f.new({},"earth-parent");r.addChild(s);s.addChild(f.new({state:function(e){d.get("earth").use().setDayTxSampler("earth-day").setNightTxSampler("earth-night").setSpecularMapTxSampler("earth-specular-map").setSunPosition(solarSystem.sunPosition).setMoonPosition(solarSystem.moonPosition);e.OUTPUT_ALPHA_PARAMETER=1},shape:"ball",children:false},"earth"));let i=(40+earthRadius)/earthRadius;s.addChild(f.new({transform:Float4x4.scale(i),state:function(e){d.get("clouds").use().setSunPosition(solarSystem.sunPosition).setMoonPosition(solarSystem.moonPosition);e.OUTPUT_ALPHA_PARAMETER=.9;e.TEXTURE_SAMPLER="clouds"},shape:"ball",children:false},"clouds"));let u=(160+earthRadius)/earthRadius;s.addChild(f.new({transform:Float4x4.scale(u),state:function(e){d.get("atmosphere").use().setAtmosphereDepth(u-1).setSunPosition(solarSystem.sunPosition).setMoonPosition(solarSystem.moonPosition);e.OUTPUT_ALPHA_PARAMETER=.5},shape:"ball",children:false},"atmosphere"));F.new({node:"world",update:function(e){let t=computeGmstFromJ2000(e);f.get(this.node).transform=Float4x4.rotateY(Utility.degreesToRadians(t))}},"world")};let K=function(t){let a=cameraSettings[v.name];if(t[2]!==0&&"wheel"in v){let e=v.wheel.inc>0?{min:"min",max:"max"}:{min:"max",max:"min"};if(t[2]>0){v[v.wheel.field]=Math[e.min](v[v.wheel.field]+v.wheel.inc,v.wheel.limitUp)}else{v[v.wheel.field]=Math[e.max](v[v.wheel.field]-v.wheel.inc,v.wheel.limitDown)}}let l=1;switch(v.type){case"target":case"portrait":case"orbit":{let e=Float2.add(a.currentPosition,[t[0],-l*t[1]]);e[0]=Utility.unwind(e[0],2);e[1]=Math.max(Math.min(e[1],.9),-.9);a.currentPosition=e;break}case"ots":{let e=Float2.add(a.currentPosition,[t[0]*3,-l*t[1]*.75]);e[0]=Math.max(Math.min(e[0],1),-1);e[1]=Math.max(Math.min(e[1],1),-1);a.currentPosition=e;break}}};let v;let U;let Q=function(e){currentCameraIndex=e;v=cameras[currentCameraIndex];U.innerHTML=v.name;if(!(v.name in cameraSettings)){cameraSettings[v.name]={currentPosition:"default"in v?v.default:[0,0]}}};let $=function(e){Q((currentCameraIndex+1)%cameras.length)};let ee=function(e){R=(R+1)%6};let te;let ae=function(){clearTimeout(te);Q(0);window.requestAnimationFrame(O);setTimeout(()=>{document.getElementById(t).style.opacity=0},50)};let le=["Andromeda","Antlia","Apus","Aquarius","Aquila","Ara","Aries","Auriga","Bootes","Caelum","Camelopardalis","Cancer","Canes Venatici","Canis Major","Canis Minor","Capricornus","Carina","Cassiopeia","Centaurus","Cepheus","Cetus","Chamaeleon","Circinus","Columba","Coma Berenices","Corona Australis","Corona Borealis","Corvus","Crater","Crux","Cygnus","Delphinus","Dorado","Draco","Equuleus","Eridanus","Fornax","Gemini","Grus","Hercules","Horologium","Hydra","Hydrus","Indus","Lacerta","Leo","Leo Minor","Lepus","Libra","Lupus","Lynx","Lyra","Mensa","Microscopium","Monoceros","Musca","Norma","Octans","Ophiuchus","Orion","Pavo","Pegasus","Perseus","Phoenix","Pictor","Pisces","Piscis Austrinus","Puppis","Pyxis","Reticulum","Sagitta","Sagittarius","Scorpius","Sculptor","Scutum","Serpens","Sextans","Taurus","Telescopium","Triangulum","Triangulum Australe","Tucana","Ursa Major","Ursa Minor","Vela","Virgo","Volans","Vulpecula"];let oe=function(e){te=setTimeout(function(){oe(300);let e=le[Math.floor(Math.random()*le.length)];document.getElementById(t).innerHTML='<span style="margin-top: 25%;text-align: center;">'+e+"</span>"},e)};oe(2e3);i=document.getElementById(e);k.new({elementId:e,onReady:o.new(null,K),stepSize:.0025});x=document.getElementById(D);x.addEventListener("click",ee);U=document.getElementById(cameraDivId);U.addEventListener("click",$);z=B.new({canvasDivId:e,loaders:[Y.new("https://astro.irdev.us/shaders/@.glsl").addFragmentShaders(["earth","clouds","atmosphere","shadowed","shadowed-texture","hardlight"]),n.new({type:r,path:"https://astro.irdev.us/textures/@.png"}).addItems(["clouds","earth-day","earth-night","earth-specular-map","moon","satellite"],{generateMipMap:true}),n.new({type:r,path:"https://astro.irdev.us/textures/@.jpg"}).addItems("starfield"),n.new({type:s,path:"https://astro.irdev.us/data/@.json"}).addItems(["bsc5-short","messier"]),X.new().addItem(s,"elements",{url:"https://bedrock.brettonw.com/api?event=fetch&url=https://www.celestrak.com/NORAD/elements/gp.php%3FGROUP%3Dactive%26FORMAT%3Dtle"})],onReady:o.new(null,function(e){d.new({vertexShader:"basic"},"earth");d.new({vertexShader:"basic"},"clouds");d.new({vertexShader:"basic"},"atmosphere");d.new({vertexShader:"basic"},"shadowed");d.new({vertexShader:"basic"},"shadowed-texture");d.new({vertexShader:"basic"},"hardlight");Z();N(a);V(ae)})});return a};