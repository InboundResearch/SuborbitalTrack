import{WebGL2,LogLevel,Utility,Float2,Float3,Float4x4}from"https://webgl.irdev.us/modules/webgl.mjs";export let SuborbitalTrack=function(e,t=function(e){}){let l=Object.create(null);let n=l.wgl=WebGL2();let a=n.ClassBase;let o=n.RollingStats;let S=n.PointerTracker;let r=n.OnReady;let i=n.Render;let s=n.LoaderShader;let d=n.LoaderPath;let u=n.Texture;let c=n.TextFile;let T=n.Loader;let h=n.Program;let x=n.makeBall;let f=n.makeFan;let y=n.Shape;let R=n.Node;let g=n.Thing;let E=Object.create(null);let I=function(e){let t=e.getUTCHours();let l=e.getUTCMinutes();let a=e.getUTCSeconds();let n=e.getUTCMilliseconds();let o=t+l/60+a/(60*60)+n/(1e3*60*60);let r=e.getUTCMonth()+1;let i=e.getUTCDate();let s=e.getUTCFullYear();let d=Math.floor;return 367*s-d(7*(s+d((r+9)/12))/4)+d(275*r/9)+i-730531.5+o/24};let A=function(e){let t=e/36525;let l=67310.54841+(876600*60*60+8640184.812866)*t+.093104*t*t-62e-7*t*t*t;return Utility.degreesToRadians(Utility.unwindDegrees(l/240))};let O=function(e){let t=Utility.cos;let l=Utility.sin;const a=36525;let n=e/a;let o=(280.46646+n*(36000.76983+n*3032e-7))%360;let r=357.52911+n*(35999.05029-1537e-7*n);let i=o+l(r)*(1.914602-n*(.004817+14e-6*n))+l(2*r)*(.019993-101e-6*n)+l(3*r)*289e-6;let s=i-.00569-.00478*l(125.04-1934.136*n);let d=l(s);let u=23+(26+(21.448-n*(46.815+n*(59e-5-n*.001813)))/60)/60;let c=u+.00256*t(125.04-1934.136*n);E.ra=Math.atan2(t(c)*d,t(s));E.dec=Math.asin(l(c)*d);let T=A(e);E.ra=Utility.unwindRadians(E.ra-T)};let L;let m;let w=Object.create(null);let C;let p=document.visibilityState;document.addEventListener("visibilitychange",function(e){p=document.visibilityState;b()});let _="focus";window.addEventListener("focus",function(e){_="focus";b()});window.addEventListener("blur",function(e){_="blur";b()});let F=true;let b=function(){if(p==="visible"&&_==="focus"){F=true;C.focus();window.requestAnimationFrame(N)}else{F=false}};let M=performance.now();let U=Date.now()-M;let P=1;let D;let N=function(e){if(F===true){let e=performance.now();window.requestAnimationFrame(N);if(document.hidden){return}let t=M+U+P*(e-M);let l=new Date(t);D=I(l);g.updateAll(D);let a=n.getContext();w.MODEL_MATRIX_PARAMETER=Float4x4.IDENTITY;w.PROJECTION_MATRIX_PARAMETER=Float4x4.orthographic(-1,1,-.5,.5,0,2);w.VIEW_MATRIX_PARAMETER=Float4x4.IDENTITY;w.MODEL_MATRIX_PARAMETER=Float4x4.IDENTITY;m.traverse(w)}};let v=function(){let t=n.getContext();m=R.new({transform:Float4x4.IDENTITY,state:function(e){t.clearColor(0,0,0,1);t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);t.enable(t.CULL_FACE);t.cullFace(t.BACK);t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);t.enable(t.BLEND);e.OUTPUT_ALPHA_PARAMETER=1;e.AMBIENT_LIGHT_COLOR=[.8,.8,1];e.LIGHT_COLOR=[1,1,.8];e.LIGHT_DIRECTION=Float3.normalize([1.55,1.75,1.45]);e.AMBIENT_CONTRIBUTION=.25;e.DIFFUSE_CONTRIBUTION=.75;e.SPECULAR_CONTRIBUTION=.05;e.SPECULAR_EXPONENT=8}},"root");m.addChild(R.new({transform:Float4x4.scale([1,.5,1]),enabled:true,state:function(e){h.get("suborbital-earth").use().setDayTxSampler("earth-day").setNightTxSampler("earth-night").setSunRaDec([E.ra,E.dec]);e.MODEL_COLOR=[1,1,1]},shape:"square",children:false}));g.new({node:"earth",update:function(e){O(e)}},"earth");let e=JSON.parse(c.get("ground-stations").text);for(let r of e){if(r.authority==="CSpOC"){let l=[];let a=[r.longitude/180,r.latitude/180];let e=32;let n=Math.PI*2/e;let o=.02;for(let t=0;t<e;++t){let e=t*n;l.push(Float2.add(a,Float2.scale([Math.cos(e),Math.sin(e)],o)));LogLevel.info("Pt: "+t+", currentAngle: "+e)}let t="fan-"+r.id;f(t,l);m.addChild(R.new({transform:Float4x4.translate([0,0,-.1]),state:function(e){h.get("basic").use();e.MODEL_COLOR=[1,.75,.5];e.OUTPUT_ALPHA_PARAMETER=.25},shape:t,children:false}))}}N()};C=document.getElementById("render-canvas-div");L=i.new({canvasDivId:"render-canvas-div",loaders:[s.new("shaders/@.glsl").addFragmentShaders(["suborbital-earth"]),d.new({type:u,path:"textures/@.png"}).addItems(["earth-day","earth-night"],{generateMipMap:true}),d.new({type:c,path:"data/@.json"}).addItems(["ground-stations"]),T.new().addItem(c,"elements",{url:"https://bedrock.brettonw.com/api?event=fetch&url=https://www.celestrak.com/NORAD/elements/gp.php%3FGROUP%3Dactive%26FORMAT%3Dtle"})],onReady:r.new(null,function(e){h.new({vertexShader:"basic"},"suborbital-earth");v()})});l.addPoint=function(e,t,l){};l.updateVis=function(e,t=Date.now()){LogLevel.info("Update Vis called with "+e.length+" elements, at "+t.toString())};return l};